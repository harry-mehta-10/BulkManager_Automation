<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KLH Manager Assignment Automation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Password Screen Styles */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 32px;
            padding: 50px;
            box-shadow: 
                0 50px 100px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .password-header {
            margin-bottom: 40px;
        }

        .password-header h1 {
            color: #ffffff;
            font-size: 2.5rem;
            margin-bottom: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 50%, #ffffff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .password-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            font-weight: 400;
            line-height: 1.6;
        }

        .password-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .password-input {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 16px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .password-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
        }

        .password-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .password-submit {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 10px 30px rgba(255, 107, 107, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 700;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .password-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .password-submit:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 20px 40px rgba(255, 107, 107, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .password-submit:hover::before {
            left: 100%;
        }

        .password-error {
            color: #ff6b6b;
            font-size: 14px;
            font-weight: 500;
            padding: 12px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            display: none;
        }

        .lock-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px auto;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        /* Main App Styles (same as before) */
        .main-app {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 32px;
            padding: 50px;
            box-shadow: 
                0 50px 100px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 2px;
        }

        .header h1 {
            color: #ffffff;
            font-size: 3.5rem;
            margin-bottom: 16px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 50%, #ffffff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
            transition: all 0.3s ease;
            cursor: default;
        }

        .header h1:hover {
            background-position: 100% 100%;
            transform: scale(1.02);
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.3));
        }

        .header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .upload-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 32px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .upload-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .upload-card:hover::before {
            opacity: 1;
        }

        .upload-card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
        }

        .file-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
        }

        .file-input:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }

        .file-input::file-selector-button {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            margin-right: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input::file-selector-button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
        }

        .filter-section {
            text-align: center;
            margin: 40px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            max-width: 700px;
            margin: 40px auto;
        }

        .filter-section div {
            display: flex;
            flex-direction: column;
        }

        .filter-section label {
            font-weight: 600;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-section select {
            padding: 14px 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            width: 100%;
            font-size: 15px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .filter-section select:hover,
        .filter-section select:focus {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.1);
            outline: none;
        }

        .filter-section select option {
            background: #1a1a2e;
            color: white;
        }

        .process-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
            color: white;
            border: none;
            padding: 18px 48px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 10px 30px rgba(255, 107, 107, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 700;
            margin: 40px auto;
            display: block;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .process-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .process-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 20px 40px rgba(255, 107, 107, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .process-btn:hover::before {
            left: 100%;
        }

        .process-btn:disabled {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: rgba(255, 255, 255, 0.4);
        }

        .results-section {
            margin-top: 40px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 28px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .output-area {
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.2) 0%, rgba(0, 0, 0, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 24px;
            color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .output-area::-webkit-scrollbar {
            width: 8px;
        }

        .output-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .output-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .output-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .download-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
            background: linear-gradient(135deg, #4fd687 0%, #46c4ba 100%);
        }

        .file-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .file-success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
        }

        .file-error {
            background: rgba(245, 101, 101, 0.1);
            color: #e53e3e;
        }

        .instructions {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 40px;
            color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .instructions h3 {
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.2rem;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .instructions ul {
            margin-left: 24px;
            list-style: none;
            position: relative;
        }

        .instructions li {
            margin-bottom: 12px;
            position: relative;
            padding-left: 12px;
            line-height: 1.6;
        }

        .instructions li::before {
            content: 'â†’';
            position: absolute;
            left: -8px;
            color: #4ecdc4;
            font-weight: bold;
        }

        .footer {
            margin-top: 60px;
            padding: 40px 20px 20px 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .footer-logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .footer-divider {
            width: 2px;
            height: 30px;
            background: linear-gradient(180deg, #ff6b6b, #4ecdc4, #45b7d1);
            border-radius: 1px;
        }

        .footer-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            font-weight: 500;
        }

        .copyright {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            font-weight: 400;
            margin-top: 16px;
        }

        .copyright .highlight {
            color: #4ecdc4;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .footer-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .footer-divider {
                width: 30px;
                height: 2px;
            }

            .password-card {
                padding: 30px 20px;
                margin: 0 20px;
            }

            .password-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Password Screen -->
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-card">
            <div class="password-header">
                <div class="lock-icon">ðŸ”’</div>
                <h1>Secure Access</h1>
                <p>Please enter the access code to continue to the KLH Manager Assignment Tool</p>
            </div>
            
            <form class="password-form" onsubmit="checkPassword(event)">
                <input 
                    type="password" 
                    id="passwordInput" 
                    class="password-input" 
                    placeholder="Enter access code"
                    autocomplete="off"
                    required
                >
                <div id="passwordError" class="password-error"></div>
                <button type="submit" class="password-submit">
                    Access Application
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <h1>KLH Manager Assignment Automation</h1>
                <p>Automate bulk manager role assignments for Kinaxis Learning Hub</p>
            </div>

            <div class="instructions">
                <h3>How to use:</h3>
                <ul>
                    <li>Upload the exported CSV file from KLH </li>
                    <li>Upload the team's data CSV file (contains admin/manager information)</li>
                    <li>Keep company filter as auto and select department filter if needed.</li>
                    <li>Click "Process Assignment" to generate bulk assignment format</li>
                    <li>Copy the output or download as CSV for bulk upload to KLH</li>
                </ul>
            </div>

            <div class="upload-section">
                <div class="upload-card">
                    <h3>KLH Export File</h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="klhFile" class="file-input" accept=".csv">
                    </div>
                    <div id="klhStatus" class="file-status" style="display: none;"></div>
                </div>
                
                <div class="upload-card">
                    <h3>Team Data File</h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="teamFile" class="file-input" accept=".csv">
                    </div>
                    <div id="teamStatus" class="file-status" style="display: none;"></div>
                </div>
            </div>

            <div class="filter-section">
                <div>
                    <label for="companySelect">Select Company:</label>
                    <select id="companySelect">
                        <option value="">Auto-detect from files</option>
                    </select>
                </div>
                <div>
                    <label for="departmentSelect">Filter by Department:</label>
                    <select id="departmentSelect">
                        <option value="">All Departments</option>
                    </select>
                </div>
            </div>

            <button id="processBtn" class="process-btn" disabled>Process Assignment</button>

            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="stats">
                    <div class="stat-card">
                        <div id="totalUsers" class="stat-number">0</div>
                        <div class="stat-label">Total Managees</div>
                    </div>
                    <div class="stat-card">
                        <div id="totalManagers" class="stat-number">0</div>
                        <div class="stat-label">Managers Found</div>
                    </div>
                    <div class="stat-card">
                        <div id="assignmentsCreated" class="stat-number">0</div>
                        <div class="stat-label">Assignments Created</div>
                    </div>
                </div>

                <div id="outputArea" class="output-area"></div>
                
                <button id="downloadBtn" class="download-btn">Download CSV</button>
            </div>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-logo">KLH AUTOMATION</div>
                <div class="footer-divider"></div>
                <div class="footer-text">Professional Manager Assignment Tool</div>
            </div>
            <div class="copyright">
                Crafted with precision by <span class="highlight">Harry Mehta</span> Â© 2025
            </div>
        </footer>
    </div>

    <script>
        // Password protection
        const CORRECT_PASSWORD = 'kinaxis2025';
        
        function checkPassword(event) {
            event.preventDefault();
            
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === CORRECT_PASSWORD) {
                // Hide password screen and show main app
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Store authentication state (session only)
                sessionStorage.setItem('authenticated', 'true');
            } else {
                // Show error message
                passwordError.textContent = 'Incorrect access code. Please try again.';
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                
                // Shake animation for error feedback
                passwordInput.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        }

        // Check if already authenticated on page load
        window.addEventListener('load', function() {
            const isAuthenticated = sessionStorage.getItem('authenticated');
            if (isAuthenticated === 'true') {
                document.getElementById('passwordOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            }
        });

        // Add shake animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);

        // Main application variables
        let klhData = null;
        let teamData = null;
        let processedOutput = '';

        // Event listeners for main app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('klhFile').addEventListener('change', handleKLHFile);
            document.getElementById('teamFile').addEventListener('change', handleTeamFile);
            document.getElementById('processBtn').addEventListener('click', processAssignment);
            document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
        });

        function handleKLHFile(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        klhData = results.data;
                        showFileStatus('klhStatus', `Loaded ${klhData.length} users from KLH export`, 'success');
                        updateDropdowns();
                        checkReadyToProcess();
                    },
                    error: function(error) {
                        showFileStatus('klhStatus', `Error reading file: ${error.message}`, 'error');
                    }
                });
            }
        }

        function handleTeamFile(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        teamData = results.data;
                        showFileStatus('teamStatus', `Loaded ${teamData.length} records from team data`, 'success');
                        updateDropdowns();
                        checkReadyToProcess();
                    },
                    error: function(error) {
                        showFileStatus('teamStatus', `Error reading file: ${error.message}`, 'error');
                    }
                });
            }
        }

        function updateDropdowns() {
            const companySelect = document.getElementById('companySelect');
            const departmentSelect = document.getElementById('departmentSelect');
            const companies = new Set();
            const departments = new Set();
            
            // Extract companies from email domains
            if (klhData) {
                klhData.forEach(user => {
                    const email = user['Email'] || user['Email Address'] || '';
                    if (email && email.includes('@')) {
                        const domain = email.split('@')[1];
                        const company = domain.split('.')[0];
                        companies.add(company.toLowerCase());
                    }
                });
            }
            
            // Extract departments and companies from team data
            if (teamData) {
                teamData.forEach(user => {
                    const dept = user['Department'];
                    if (dept && dept.trim() !== '') {
                        departments.add(dept.trim());
                    }
                    
                    const email = user['Email Address'] || user['Email'] || '';
                    if (email && email.includes('@')) {
                        const domain = email.split('@')[1];
                        const company = domain.split('.')[0];
                        companies.add(company.toLowerCase());
                    }
                });
            }
            
            // Clear and populate company dropdown
            companySelect.innerHTML = '<option value="">Auto-detect from files</option>';
            [...companies].sort().forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company.charAt(0).toUpperCase() + company.slice(1);
                companySelect.appendChild(option);
            });
            
            // Clear and populate department dropdown
            departmentSelect.innerHTML = '<option value="">All Departments</option>';
            [...departments].sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }

        function showFileStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `file-status file-${type}`;
            statusEl.style.display = 'block';
        }

        function checkReadyToProcess() {
            const processBtn = document.getElementById('processBtn');
            if (klhData && teamData) {
                processBtn.disabled = false;
                processBtn.textContent = 'Process Assignment';
            }
        }

        function processAssignment() {
            if (!klhData || !teamData) return;

            const selectedCompany = document.getElementById('companySelect').value.toLowerCase();
            const selectedDepartment = document.getElementById('departmentSelect').value;
            
            // Helper function to extract company name from email
            function getCompanyFromEmail(email) {
                if (!email || !email.includes('@')) return '';
                const domain = email.split('@')[1];
                return domain.split('.')[0].toLowerCase();
            }
            
            // Determine target company
            let targetCompany = selectedCompany;
            if (!targetCompany && klhData.length > 0) {
                const firstUserEmail = klhData[0]['Email'] || klhData[0]['Email Address'] || '';
                targetCompany = getCompanyFromEmail(firstUserEmail);
            }
            
            // Extract managees from KLH export
            let managees = klhData
                .map(user => user['Email'] || user['Email Address'] || '')
                .filter(email => email && email.trim() !== '');
            
            // Only filter by company if explicitly selected (not auto-detected)
            if (selectedCompany) {
                managees = managees.filter(email => {
                    return getCompanyFromEmail(email) === targetCompany;
                });
            }
            
            // Find managers from team data
            const managers = [];
            teamData.forEach(user => {
                // Check if user is marked as admin
                const isAdmin = user['Is Admin'] === 'Yes' || 
                               user['Role'] === 'Admin' || 
                               user['Admin'] === 'Yes' ||
                               user['Is Admin'] === 'yes' ||
                               user['Role'] === 'admin';
                
                if (isAdmin) {
                    const managerEmail = user['Email Address'] || user['Email'] || user['Username'] || '';
                    const managerDepartment = user['Department'] || '';
                    
                    if (managerEmail.trim() !== '') {
                        // Check company match
                        const companyMatch = !targetCompany || getCompanyFromEmail(managerEmail) === targetCompany;
                        
                        // FIXED: Use exact match instead of includes() for department filtering
                        const departmentMatch = !selectedDepartment || 
                                               managerDepartment === selectedDepartment;
                        
                        if (companyMatch && departmentMatch) {
                            managers.push({
                                email: managerEmail.trim(),
                                name: `${user['First Name'] || ''} ${user['Last Name'] || ''}`.trim() || managerEmail,
                                department: managerDepartment
                            });
                        }
                    }
                }
            });
            
            // Remove duplicate managers
            const uniqueManagers = managers.filter((manager, index, self) => 
                index === self.findIndex(m => m.email.toLowerCase() === manager.email.toLowerCase())
            );
            
            // Generate output
            let output = `Company: ${targetCompany ? targetCompany.toUpperCase() : 'ALL'}\n`;
            if (selectedDepartment) {
                output += `Department: ${selectedDepartment}\n`;
            }
            output += `Total Managees: ${managees.length}\n`;
            output += `Total Managers: ${uniqueManagers.length}\n\n`;
            
            // Error handling
            if (uniqueManagers.length === 0) {
                output += "No managers found!\n";
                output += "Please check that your team data file has users with:\n";
                output += "- 'Is Admin' = 'Yes' (or 'yes')\n";
                output += "- 'Role' = 'Admin' (or 'admin')\n";
                output += "- 'Admin' = 'Yes'\n";
                if (selectedDepartment) {
                    output += `- Department matching exactly '${selectedDepartment}'\n`;
                }
                output += "\nFound these departments in your team data:\n";
                const allDepts = new Set();
                teamData.forEach(user => {
                    const isAdmin = user['Is Admin'] === 'Yes' || user['Role'] === 'Admin' || user['Admin'] === 'Yes';
                    if (isAdmin && user['Department']) {
                        allDepts.add(user['Department']);
                    }
                });
                [...allDepts].forEach(dept => output += `- ${dept}\n`);
            }
            
            if (managees.length === 0) {
                output += "No managees found! Check your KLH export file.\n";
            }
            
            // FIXED: Generate assignments - each managee gets assigned to ALL managers
            let csvOutput = 'Managee,Manager\n';
            let assignmentCount = 0;
            
            if (uniqueManagers.length > 0 && managees.length > 0) {
                // Show selected managers
                output += "Selected Managers:\n";
                uniqueManagers.forEach((manager, index) => {
                    output += `${index + 1}. ${manager.name} (${manager.email})`;
                    if (manager.department) output += ` - ${manager.department}`;
                    output += '\n';
                });
                output += "\n" + "=".repeat(80) + "\n\n";
                
                // FIXED: Create assignments - each managee to every manager
                uniqueManagers.forEach((manager, managerIndex) => {
                    output += `MANAGER ${managerIndex + 1}: ${manager.name} (${manager.email})`;
                    if (manager.department) output += ` - ${manager.department}`;
                    output += `\n\nAssigned managees (${managees.length}):\n`;
                    
                    managees.forEach(managee => {
                        output += `${managee} -> ${manager.email}\n`;
                        csvOutput += `${managee},${manager.email}\n`;
                        assignmentCount++;
                    });
                    output += "\n" + "=".repeat(80) + "\n\n";
                });
            }
            
            processedOutput = csvOutput;
            
            // Update UI
            document.getElementById('totalUsers').textContent = managees.length;
            document.getElementById('totalManagers').textContent = uniqueManagers.length;
            document.getElementById('assignmentsCreated').textContent = assignmentCount;
            document.getElementById('outputArea').textContent = output;
            document.getElementById('resultsSection').style.display = 'block';
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadCSV() {
            if (!processedOutput) return;

            const blob = new Blob([processedOutput], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'klh_manager_assignments.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>